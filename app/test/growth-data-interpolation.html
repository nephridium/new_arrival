<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <title>my-greeting-basic</title>

  <script src="../../bower_components/webcomponentsjs/webcomponents.min.js"></script>
  <script src="../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../bower_components/test-fixture/test-fixture-mocha.js"></script>
  <link rel="import" href="../../bower_components/polymer/polymer.html">
  <link rel="import" href="../../bower_components/test-fixture/test-fixture.html">

  <!-- Helper elements -->
  <link rel="import" href="../../bower_components/iron-ajax/iron-request.html">

  <!-- Elements to test -->
  <link rel="import" href="../elements/arrival-milestones/arrival-milestones.html">

</head>
<body>

  <test-fixture id="data-request">
    <template>
      <iron-request></iron-request>
    </template>
  </test-fixture>

  <test-fixture id="milestones">
    <template>
      <arrival-milestones></arrival-milestones>
    </template>
  </test-fixture>

  <script>

    suite('Growth data interpolation tests', function() {
      var jsonResponseHeaders;
      var urls;
      var request;
      var element;

      var genders = ['female', 'male'];
      var dimensions = ['height', 'weight'];

      setup(function () {
        jsonResponseHeaders = {
          'Content-Type': 'application/json'
        };

        request = fixture('data-request');
        urls = {
          female: {
            height: '../elements/arrival-milestones/lhfa_girls_p_exp.json',
            weight: '../elements/arrival-milestones/wfa_girls_p_exp.json'
          },
          male: {
            height: '../elements/arrival-milestones/lhfa_boys_p_exp.json',
            weight: '../elements/arrival-milestones/wfa_boys_p_exp.json'
          }
        };

        element = fixture('milestones');

      });

      teardown(function () {
      });

      test('Retrieve source data correctly', function (done) {
        request.send({ url: urls.female.height, handleAs: 'json' });

        request.completes.then(function() {
          expect(request.response).to.be.an('array');
          done();
        }).catch(function(e) {
          done(new Error(e));
        });
      });

      test('Element arrival-milestones initialized correctly', function (done) {
        request.send({ url: urls.female.height, handleAs: 'json' });

        request.completes.then(function() {
          expect(element.ready).to.be.a('function');
          expect(element.formulaValidity).to.be.above(0);
          expect(request.response.length).to.be.at.least(element.formulaValidity);
          expect(element.selectOptions).to.be.an('object');
          expect(element.selectOptions).to.have.keys(['year', 'month', 'day', 'years', 'months', 'days']);
          expect(element.updateTime).to.be.a('function');
          expect(element.sufficientData).to.be.a('function');
          expect(element.toggleBabyProperties).to.be.a('function');
          done();
        }).catch(function(e) {
          done(new Error(e));
        });
      });

      test('Check female weight data', function (done) {
        var gender = 'female';
        var dimension = 'weight';
        var maxDeviation = 0.1;

        request.send({ url: urls[gender][dimension], handleAs: 'json' });

        request.completes.then(function() {
          var delta;
          for (var i=0; i < 10; i++) {
            element.setPercentiles(gender, i);
            delta = element.percentiles[dimension].P50 - request.response[i].P50;
            console.log(
                i,
                Math.round(element.percentiles[dimension].P50 * 1e4) / 1e4,
                Math.round(request.response[i].P50 * 1e4) / 1e4,
                'Î” ' + delta.toFixed(4)
            );
            expect(delta).to.be.below(maxDeviation);
          }
          done();
        }).catch(function(e) {
          done(new Error(e));
        });
      });

    });
  </script>

</body>
</html>
